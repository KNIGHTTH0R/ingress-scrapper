var apiRegion=1,showPub=!0,showEn=!1,showRe=!1,refreshInterval=30,maxIdleTime=5,apiKey=getURLParam("key"),apiUrl="http://ingress.writhem.com/api/?table=chat&key="+apiKey;
jQuery(function(a){a("a.asynclink").click(function(b){b.preventDefault();b=a(this);a.get(b.attr("href"),function(){refresh()})});a("body").mousemove(idleReset).keypress(idleReset);a("#chat").scroll(function(){var b=a(this);if(b.data("ignoreNextScroll"))return b.data("ignoreNextScroll",!1);0===b.scrollTop()&&loadJSON(!1);0===scrollBottom(b)&&loadJSON(!0)})});var last=0,first=(new Date).getTime()/1E3,loaded=!1;
$(document).ready(function(){refresh();start_info_refresh();window.addResumeFunction(loadJSON);window.addResumeFunction(start_info_refresh)});
var info_refresh=null,start_info_refresh=function(){null==info_refresh&&(info_refresh=setInterval(refresh,1E3*refreshInterval))},stop_info_refresh=function(){info_refresh=null},refresh=function(){isIdle()?$("#status").html("Idle, not updating"):(loadJSON(!1),applyFilters())},loadJSON=function(a){var b=apiUrl+"&after="+last;a&&(b=apiUrl+"&before="+first);console.log(b);$("#loading").show();$("#status").html("Loading...");b=$.getJSON(b,function(b){b&&!a?jQuery.each(b.reverse(),function(){$("#chat").prepend(buildLog(this))}):
b&&jQuery.each(b,function(){$("#chat").append(buildLog(this))})});$.when(b).done(function(){$("#loading").hide();$("#status").html("Up to date.");loaded=!0;applyFilters()})},buildLog=function(a){var b=new Date(1E3*a.datetime);a.datetime>last&&(last=a.datetime+1);a.datetime<first&&(first=a.datetime-1);var c=0;"RESISTANCE"==a.channel?c=1:"ENLIGHTENED"==a.channel&&(c=2);c='  <p class="region-'+a.region[0].guid+" channel-"+c+'"  style="display: none;">\n';c=c+'    <time class="timestamp" title="'+b.toString();
c+='" data-timestamp="'+a.datetime+'">'+b.getHours()+":"+b.getMinutes()+"</time>\n";c+='    <span class="invisibleseparator"> &lt;</span> \n';c+='    <span class="'+a.user[0].faction+'">'+a.user[0].name+"</span> \n";c+='    <span class="invisibleseparator">&gt; </span> \n';c+='    <span class="'+a.channel+'">'+a.text+"</span> \n";return c+="  </p>"},applyFilters=function(){1==apiRegion?($("#Calgary").addClass("active"),$("#Edmonton").removeClass("active")):($("#Edmonton").addClass("active"),$("#Calgary").removeClass("active"));
$("#chat > p").each(function(){$(this).hasClass("region-"+apiRegion)?(showPub?($("#showPub").addClass("active"),$(this).hasClass("channel-0")&&$(this).show()):($("#showPub").removeClass("active"),$(this).hasClass("channel-0")&&$(this).hide()),showRe?($("#showRe").addClass("active"),$(this).hasClass("channel-1")&&$(this).show()):($("#showRe").removeClass("active"),$(this).hasClass("channel-1")&&$(this).hide()),showEn?($("#showEn").addClass("active"),$(this).hasClass("channel-2")&&$(this).show()):($("#showEn").removeClass("active"),
$(this).hasClass("channel-2")&&$(this).hide())):$(this).hide()});needMoreMessages()},toggleChannel=function(a){"Pub"==a?showPub=showPub?!1:!0:"Re"==a?showRe=showRe?!1:!0:"En"==a&&(showEn=showEn?!1:!0);applyFilters()},toggleRegion=function(a){apiRegion=a;applyFilters()};function scrollBottom(a){"string"===typeof a&&(a=$(a));return a.get(0).scrollHeight-a.innerHeight()-a.scrollTop()}
function getURLParam(a){var b=document.URL,c=b.indexOf(a);if(-1>=c)return"";b=b.substr(c);c=b.indexOf("&");0<=c&&(b=b.substr(0,c));return b.replace(a+"=","")}function needMoreMessages(){var a=$("#chat");if((showPub||showRe||showEn)&&loaded)0!==scrollBottom(a)||0!==a.scrollTop()||(console.log("no scrollbar in active chat, requesting more msgs"),$("#chat").length&&loadJSON(!0))}window.idleTime=0;window._onResumeFunctions=[];setInterval("window.idleTime += 1",6E4);
var idleReset=function(){isIdle()&&(window.idleTime=0,$.each(window._onResumeFunctions,function(a,b){console.log(b);b()}));window.idleTime=0};window.isIdle=function(){return window.idleTime>=maxIdleTime};window.addResumeFunction=function(a){window._onResumeFunctions.push(a)};